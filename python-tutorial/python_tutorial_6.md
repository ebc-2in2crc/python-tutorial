# 6. モジュール

- モジュールは Python の定義や文が入ったファイル。ファイル名はモジュール名に接尾語 `.py` がついたものになル
- モジュールにある定義は、他のモジュールや main モジュールに `import` (取り込み) することができる
- モジュールの中では、(文字列の) モジュール名をグローバル変数 `__name__` で取得
- `import <モジュール名>` は、`<モジュール名>` だけを名前空間に追加する
    - モジュール内の関数には `<モジュール名>.<関数名>` でアクセスする

## 6.1. モジュールについてもうすこし

- モジュールには、関数定義に加えて実行文を含められる
    - これらの実行文はモジュールを初期化するためのもの
    - これらの実行文は、インポート文の中で最初にモジュール名が見つかったときにだけ実行される。(ファイルがスクリプトとして実行される場合も実行されます。)
- 各々のモジュールは、自分のプライベートな名前空間を持っている
    - モジュールで定義されている関数はこのテーブルをグローバルな名前空間として使う
    - したがって、モジュールの作者はユーザのグローバル変数と偶然的な衝突が起こる心配をせずに、モジュール内でグローバル変数を使える
    - 一方、自分が行っている操作をきちんと理解していれば、モジュール内の関数を参照するのと同じ表記法 `modname.itemname` で、モジュールのグローバル変数をいじることもでき
- モジュールは他のモジュールをインポートできる
    - `import` 文はモジュールの先頭に置くが、これは慣習であって必須ではない
    - インポートされたモジュール名は、モジュールのトップレベルに書いてあればモジュールのグローバルな名前空間に置かれる

`import` 文の変形をいくつか。

```python
from fibo import fib   # fibo モジュール内の fib 関数を、import を実行したモジュールの名前空間内に直接取り込む。
                       # この場合、import を実行したモジュールの名前空間には fibo は取り込まれない。
                       
from fibo import *     # fibo モジュール内の名前をすべて import する。
                       # 殆どの場面で、Python プログラマーはこの書き方は使わない。
                       # 未知の名前がインタープリターに読み込まれ、定義済みの名前を上書きしてしまう可能性があるため。
                     
import fibo as my_fibo # import したモジュールにエイリアスを付ける
```

### 6.1.1. モジュールをスクリプトとして実行する

`python <モジュール名> <arguments>` を実行すると、`__name__` に `__main__` が設定されている点を除いては、 `import` したときと同じようにモジュール内のコードが実行される。
つまり、モジュールの末尾に次のコードを追加することにより、スクリプトとしても実行できるようになる。
また、モジュールが `import` された場合には、次のコードは実行されない。

```python
f __name__ == "__main__":
    import sys
    
    # 行いたい処理をここに書く
```

### 6.1.2. モジュール検索パス

インタープリタがモジュールを探して読み込む順番および場所は、次のとおり。

1. 組み込みモジュール。組み込みモジュール名の一覧は `sys.builtin_module_names` にある
2. `sys.path` ディレクトリのリスト。`sys.path` は以下の場所に初期化される
    1. 入力されたスクリプトのあるディレクトリ (あるいはファイルが指定されなかったときはカレントディレクトリ)
    2. `PYTHONPATH` (ディレクトリ名のリスト。シェル変数の PATH と同じ構文)。
    3. インストール方法に依存したデフォルト (慣例として `site-packages` ディレクトリーが含まれ、`site` モジュールによって処理される)

### 6.1.3. "コンパイル" された Python ファイル

-  Python はコンパイル済みの各モジュールをキャッシュする
    - モジュールの読み込みを高速化するため。
    - キャッシュ先は`__pycache__` ディレクトリで、`module.version.pyc` というファイル名でキャッシュされる
    - `version` はコンパイルされたファイルのフォーマットを表すもので、一般的には Python のバージョン番号
    - 例えば、CPython のリリース 3.3 の、コンパイル済みの `spam.py` は `__pycache__/spam.cpython-33.pyc` としてキャッシュされる
    - この命名の慣習により、Python の異なる複数のリリースやバージョンのコンパイル済みモジュールが共存できる
- Python はキャッシュを自動的に更新する
    - ソースの変更日時 > コンパイル済みの変更日時であることを検知した場合、再コンパイルを行う
    - また、コンパイル済みモジュールはプラットフォーム非依存なため、アーキテクチャの異なるシステム間でも共有できる

## 6.2. 標準モジュール

- Python は標準モジュールライブラリを同梱している
- 幾つかのモジュールはインタープリタ内部にビルトインされている
    - 効率や、システムコールなど OS の機能を利用するため
- 変数 `sys.path` は文字列からなるリストで、インタプリタがモジュールを検索するときのパスを決定する
    - `sys.path` は環境変数 `PYTHONPATH` から得たデフォルトパスに、 `PYTHONPATH` が設定されていなければ組み込みのデフォルト値に設定される
    - 標準的なリスト操作で変更することができる

## 6.3. dir() 関数

組込み関数 `dir()` はソートされた文字列のリストを返す。
あるモジュールがどんな名前を定義しているか調べるために使われる。

```python
import fibo
print(dir(fibo))
# ['__builtins__', '__cached__', '__doc__', '__file__', '__loader__', '__name__', '__package__', '__spec__', 'fib', 'fib2']
```

引数が指定されない場合は、 `dir()` は現在定義しているすべての名前、つまり、変数、モジュール、関数、その他のすべての種類の名前をリストする。

```python
a = [1, 2, 3, 4, 5]
import fibo
fib = fibo.fib
print(dir())

# ['__annotations__', '__builtins__', '__cached__', '__doc__', '__file__', '__loader__', '__name__', '__package__', '__spec__', 'a', 'fib', 'fibo']
```

`dir()` は、組込みの関数や変数の名前はリストしない。
これらの名前をリストするときは 標準モジュール `builtins` を `dir()` に指定して実行する。

## 6.4. パッケージ

パッケージ (package) は、Python のモジュール名前空間を "ドット付きモジュール名" を使って構造化する手段。
例えば、モジュール名 `A.B` は、 `A` というパッケージのサブモジュール `B` を表す。
ドット付きモジュール名を利用すると、複数モジュールからなるパッケージの著者が、互いのモジュール名の衝突を心配しなくて済むようになる。

- パッケージを import する際、 Python は `sys.path` 上のディレクトリを検索して、トップレベルのパッケージの入ったサブディレクトリを探す
- ファイルを含むディレクトリをパッケージとしてPython に扱わせるには、ファイル `__init__.py` が必要
    - (より高度な機能 `namespace package` を使う場合を除く)
    - `string` のようなよくある名前のディレクトリをモジュールとして認識させないため。
    - `__init__.py` はただの空ファイルでもよいが、パッケージのための初期化コードを記述できる
    - また、後述の `__all__` 変数を設定することも出来る
- パッケージのユーザは、個々のモジュールをパッケージから `import` 出来る
- `import sound.effects.echo`
    - この操作はサブモジュール `sound.effects.echo` をロードする
    - ロードしたモジュールは、`sound.effects.echo.echofilter(<引数>)` のように完全な名前で参照しなければならない
- `from sound.effects import echo` 
    - この操作はサブモジュール `sound.effects.echo` をロードする
    - ロードしたモジュールは、`echo.echofilter(<引数>)` のようにパッケージ名無しで利用できる
- `from sound.effects.echo import echofilter`
    - この操作はサブモジュール `sound.effects.echo` の `echofilter` を直接ロードする
    - ロードした関数は、`echofilter(<引数>)` のように直接実行できる

### 6.4.1. パッケージから * を import する

import 文は、パッケージの `__init__.py` に `__all__` という名前のリストが定義されていたら、 `from package import *` が現れたときに import すべきモジュール名のリストとして使う。
リストを最新の状態に更新するのは、パッケージの作者の責任となる。

### 6.4.2. パッケージ内参照

パッケージがサブパッケージの集まりに構造化されている場合、絶対 `import` を使って兄弟関係にあるパッケージを参照できる。
例えば、モジュール `sound.filters.vocoder` で `sound.effects` パッケージの `echo` モジュールが必要な場合は、`from sound.effects import echo` が使える。
また、明示的な相対 `import` を `from module import name` 形式の import 文で利用できる 。
この明示的な相対 `import` では、先頭のドットで現在および親パッケージを指定する。

```python
from . import echo
from .. import formats
from ..filters import equalizer
```

### 6.4.3. 複数ディレクトリ中のパッケージ¶

この機能はほとんど必要にはならないが、パッケージ内に存在するモジュール群を拡張するために使うことができる。

## 自分自身による補遺

### 使用頻度の高い標準モジュール10選。

| 順位  | モジュール名        | 主な用途・特徴                                              |
| --- | ------------- | ---------------------------------------------------- |
| 1️⃣ | `os`          | ファイル・ディレクトリ操作、環境変数アクセスなど。クロスプラットフォーム対応。              |
| 2️⃣ | `sys`         | Python の実行環境に関する情報（`sys.argv`, `sys.path`など）。        |
| 3️⃣ | `re`          | 正規表現処理。文字列の検索・置換・抽出などで多用。                            |
| 4️⃣ | `math`        | 数学関数（平方根、三角関数、対数など）の提供。                              |
| 5️⃣ | `datetime`    | 日付・時刻の取得・計算。`date`, `time`, `datetime` クラスが豊富。       |
| 6️⃣ | `collections` | 高機能なデータ構造（`deque`, `Counter`, `defaultdict` など）。     |
| 7️⃣ | `json`        | JSON の読み書き。Web API や設定ファイルのやりとりで必須。                  |
| 8️⃣ | `random`      | 疑似乱数生成。ゲーム、サンプルデータ作成、統計処理などに。                        |
| 9️⃣ | `itertools`   | イテレータ処理の効率化。`chain`, `combinations`, `groupby` など強力。 |
| 🔟  | `pathlib`     | ファイルパス操作をオブジェクト指向的に扱える（`os.path` の上位互換的存在）。          |

### 用途別によく使われる標準モジュール

- ファイル操作系: os, pathlib, shutil
- 文字列処理系: re, string
- データ処理系: csv, json, pickle, sqlite3
- 並列処理・非同期: threading, multiprocessing, asyncio
- ユーティリティ: argparse, logging, time